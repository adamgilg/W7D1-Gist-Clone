<%= @gist.title %>
<br>
added by
<%= @gist.user.user_name %>
<br>
<%= time_ago_in_words(@gist.created_at) %> ago
<br>

<%= button_to('Favorite',
        gist_favorite_path(@gist),
        method: "post",
        remote: true,
        form_class: "favorite-gist",
        id: "favorite-button",
        hidden: @gist.favorited?(current_user)) %>

<%= button_to('Unfavorite',
        gist_favorite_path(@gist),
        method: "delete",
        remote: true,
        form_class: "favorite-gist",
        id: "unfavorite-button",
        hidden: !@gist.favorited?(current_user)) %>

<hr>
<h2>Gist Files</h2>

<% @gist.gist_files.each do |gf| %>
  <h3>Body:</h3>
  <%= gf.body %>
<% end %>

<h3>Tags</h3>
<div id="tag-box"></div>
<div class="tag-form">
  <%= simple_form_for(@gist, :method => :put) do |f| %>
    <%= f.input :tag_ids,
                collection: Tag.all,
                label_method: :name,
                value_method: :id,
                as: :check_boxes %>
    <%= f.button :submit %>
  <% end %>
</div>

<script>
  $(function(){

    $(".favorite-gist").on("ajax:success", function(event, data, status, xhr) {
      $("#favorite-button").toggle();
      $("#unfavorite-button").toggle();
    });

    $(".favorite-gist").on("ajax:error", function(event, xhr, status, error) {
      console.log("Something went wrong");
    });

    function TextSearchSelect(div, items){
      var div = $(div);
      var input = $("<input>");

      div.append(input);

      function generatedListElements(listItems){
        var ul = $("<ul>");

        $.each(listItems, function(){
          var li = $('<li>');
          li.text(this);
          ul.append(li);
        });

        return ul;
      }

      function filterList(inputValue){
        var filteredList = [];
        var filter = new RegExp(inputValue);

        $.each(items, function(){
          if (filter.exec(this)){
            filteredList.push(this);
          }
        });
        return filteredList;
      }

      function removeList(){
        div.find("ul").remove();
      }

      function addList(listItems){
        div.append(generatedListElements(listItems));
      }

      input.focus(function() {
        addList(items);
      });

      input.blur(function() {
        removeList()
      });

      input.on("keyup", function(){
        removeList();
        addList(filterList(input.val()));
      });

    }


    var tagBox = new TextSearchSelect('#tag-box', ["Funky", "Fresh", "Atrocious"]);
  });
</script>

